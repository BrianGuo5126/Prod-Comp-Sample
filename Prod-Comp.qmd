---
title: "Sample"
format: html
editor: source
---
```{r}
library(tidyverse)
library(lme4)
sample <- read.csv("~/Downloads/prodcompv1.csv") #Change CSV here
manifest <- read.csv("~/Downloads/officialmanifest.csv")
```

```{r}
df_grouped <- sample |> 
  filter(difficulty != 0, rt > 100) |>
  group_by(task, ppt_id, correct) |>
  summarise(n = n())
```

```{r}
df_demo <- filter(sample, task != "production", task != "comprehension") |> 
  select(ppt_id, response.age, response.gender)
```

```{r}
df_joined <- df_grouped |>
  left_join(df_demo, join_by(ppt_id)) |>
  filter(!is.na(response.age))
```

```{r}
ggplot(
  data = df_joined |> filter(correct == "true"),
  mapping = aes(
    x = response.age,
    y = n,
    colour = task)
  ) +
  geom_point(size = 3) +
  geom_smooth(linewidth = 1) +
  labs(
    x = "Age",
    y = "Number Correct",
    colour = "Task"
  ) +
  scale_x_continuous(
    breaks = seq(floor(min(df_joined$response.age)),
                 ceiling(max(df_joined$response.age)), 1)
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right"
  )

ggsave("prodcompage.jpg", width = 8, height = 6, dpi = 300)
```
```{r}
model1 <- lm(n ~ response.age*task,
            data = df_joined)
summary(model)
```

```{r}
ggplot(
  data = df_joined |> filter(correct == "true"),
  aes(
    x = response.age,
    y = n,
    colour = task,
    shape = response.gender
  )
) +
  geom_point(size = 3) +
  geom_smooth(
    aes(
      linetype = response.gender,
      group = interaction(task, response.gender)
    ),
    method = "lm",
    se = FALSE,
    linewidth = 1
  ) +
  scale_shape_manual(values = c("female" = 16, "male" = 17)) +
  scale_linetype_manual(
    name = "Line Style",
    values = c("female" = "dotted", "male" = "solid"),
    labels = c("Female (dotted)", "Male (solid)")
  ) +
  labs(
    x = "Age",
    y = "Number Correct",
    colour = "Task",
    shape = "Gender"
  ) +
  guides(
    linetype = guide_legend(override.aes = list(colour = "black"))
  ) +
  scale_x_continuous(breaks = seq(floor(min(df_joined$response.age)),
                                  ceiling(max(df_joined$response.age)), 1)) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

ggsave("agecorrect.jpg", width = 8, height = 6, dpi = 300)
```

```{r}
model2 <- lm(n ~ response.age*task*response.gender,
            data = df_joined)
summary(model)
```
```{r}
df_comprehension <- sample |>
  filter(
    task == "comprehension",
    correct == "true",
    difficulty != 0,
    rt > 100,
    rt < 10000
  ) |>
  select(ppt_id, difficulty, rt, correct) |>
  left_join(df_demo, by = "ppt_id")

df_participant <- df_comprehension |>
  group_by(ppt_id, response.age, difficulty) |>
  summarise(mean_rt = mean(rt, na.rm = TRUE), .groups = "drop")

ggplot(df_participant, aes(x = response.age, y = mean_rt, colour = factor(difficulty))) +
  geom_point(
    size = 2, 
    alpha = 0.6, 
    position = position_jitter(width = 0, height = 50) # only vertical jitter
  ) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 1) +
  labs(
    x = "Age",
    y = "Mean Reaction Time (ms)",
    colour = "Difficulty"
  ) +
  scale_x_continuous(
    breaks = seq(floor(min(df_participant$response.age, na.rm = TRUE)),
                 ceiling(max(df_participant$response.age, na.rm = TRUE)), 1)
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

ggsave("agetime.jpg", width = 8, height = 6, dpi = 300)

```
```{r}
df_accuracy <- df_comprehension |>
  group_by(ppt_id) |>
  summarise(accuracy = n(), .groups = "drop")

df_rt <- df_comprehension |>
  group_by(ppt_id) |>
  summarise(mean_rt = mean(rt, na.rm = TRUE), .groups = "drop")

df_accuracy_rt <- left_join(df_accuracy, df_rt, by = "ppt_id") |>
  left_join(df_demo, by = "ppt_id")

df_accuracy_rt <- df_accuracy_rt |>
  mutate(
    response.age = as.character(response.age),     
    response.age = na_if(response.age, "na"),       
    response.age = as.numeric(response.age)         
  ) |>
  filter(!is.na(response.age)) |>
  mutate(response.age = as.factor(response.age))    

ggplot(df_accuracy_rt, aes(x = accuracy, y = mean_rt, colour = response.age, 
                           shape = response.gender)) +
  geom_point(size = 3) +
  geom_smooth(
    aes(group = 1),
    method = "lm",
    colour = "darkred",
    linewidth = 1
  ) +
  scale_colour_brewer(palette = "Set1") +
  labs(
    x = "Number Correct (Accuracy)",
    y = "Mean Reaction Time (ms)",
    colour = "Age",
    shape = "Gender"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

ggsave("accuracytime.jpg", width = 8, height = 6, dpi = 300)
```
```{r}
df_errors <- sample |>
  filter(task == "comprehension", rt > 100, correct == "false", !is.na(response)) |>
  select(label, difficulty, presented_images.0., presented_images.1., 
         presented_images.2., presented_images.3., response, ppt_id) |>
  left_join(df_demo, by = "ppt_id") |>
  filter(!is.na(response.age))

df_errors <- df_errors |>
  rowwise() |>
  mutate(
    response_col = paste0("presented_images.", response, "."),
    selected_image = ifelse(response_col %in% names(cur_data()),
                            cur_data()[[response_col]],
                            NA_character_),
    selected_word = str_remove(selected_image, "^images/"),
    selected_word = str_remove(selected_word, "\\.jpg$")
  ) |>
  ungroup() |>
  filter(!is.na(selected_word))

normalize_word <- function(x) {
  x %>% tolower() %>% str_trim()
}

df_errors <- df_errors |>
  mutate(
    label = normalize_word(label),
    selected_word = normalize_word(selected_word)
  )

manifest <- manifest |>
  mutate(across(c(label, distractor1, distractor2, distractor3), normalize_word))

df_errors <- df_errors |>
  left_join(manifest, by = "label")

df_errors <- df_errors |>
  mutate(
    error_type = case_when(
      selected_word == distractor1 ~ "Close",
      selected_word == distractor2 ~ "Medium",
      selected_word == distractor3 ~ "Far"
    )
  )

df_summary <- df_errors |>
  group_by(response.age, error_type) |>
  summarise(count = n(), .groups = "drop") |>
  group_by(response.age) |>
  mutate(proportion = count / sum(count)) |>
  ungroup() |>
  arrange(as.numeric(response.age))

age_counts <- df_errors |>
  group_by(response.age) |>
  summarise(n = n_distinct(ppt_id), .groups = "drop") |>
  mutate(label = paste0("n=", n))

df_summary$error_type <- factor(df_summary$error_type,
                                levels = c("Far", "Medium", "Close"))

ggplot(df_summary, aes(x = factor(response.age), y = proportion, fill = error_type)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
            position = position_stack(vjust = 0.5), size = 4, color = "white") +
  geom_text(data = age_counts,
            aes(x = factor(response.age), y = -0.05, label = label),
            inherit.aes = FALSE, size = 4, color = "black", fontface = "bold") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(-0.1, 1)) +
  labs(
    x = "Age",
    y = "Proportion of Incorrect Responses",
    fill = "Error Distance"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(vjust = 2)
  )

ggsave("ageincorrecttype.jpg", width = 8, height = 6, dpi = 300)
```


